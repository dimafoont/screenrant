{% extends 'base.html' %}

{% block title %} {{ title }} {% endblock %}

{% block content %}
<div class="container-relevant">
    <div class="relevant-wrapper">
        <h1 class="cat-title">{{ title }}</h1>
        <p class="listing-desc">The latest {{ title }} on the Screen Rant</p>
    </div>
</div>
<div class="container">
    <div class="main-content">
        <section class="main-content-page">
            <h5 class="title-block">
                Latest
            </h5>
            <ul class="main-blog">
                {% for post in posts %}
                <li>
                    <a href="{{ post.get_absolute_url }}">
                        <div class="main-blog-img">
                            {% if post.photo %}
                            <img src="{{ post.photo.url }}" alt="img">
                            {% else %}
                            <img src="img/img5.webp" alt="img">
                            {% endif %}
                        </div>
                        <div class="main-blog-content">
                            <h2>{{ post.title }}</h2>
                            <p>{{ post.content|truncatewords_html:15|safe }}</p>
                            <span class="date">{{ post.created_at|date:"F j, Y"}}</span>
                        </div>
                    </a>
                </li>
                {% endfor %}
                {{total_obj|json_script:"json-total"}}
            </ul>
            <div class="ajax-navigation">
                <a name="{{ ajaxslug }}" class="load-more">Show more</a>
                <div id="circle2" class="not-visible">
                </div>
                <p class="no-more not-visible">No more posts</p>
            </div>
        </section>
    </div>
    <script>
        const loadBtn = document.querySelector('.load-more');
        const spinner = document.querySelector('#circle2');
        const total = JSON.parse(document.getElementById('json-total').textContent);
        const noMore = document.querySelector('.no-more');
        const ajaxNavBlock = document.querySelector('.ajax-navigation');

        function loadmorePost() {
            var _current_item = $('ul.main-blog li').length
            var _this_slug = '{{ thiscategory }}'
            const content_container = document.querySelector('ul.main-blog')
            var dateOptions = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timezone: 'UTC',

            };
            $.ajax({
                url: '{% url "load_cat" %}',
                type: 'GET',
                data: {
                    'total_item': _current_item,
                    'thisSlug': _this_slug,
                },
                beforeSend: function () {
                    loadBtn.classList.add('not-visible');
                    spinner.classList.remove('not-visible');
                },
                success: function (response) {
                    const data = response.posts
                    console.log(data)
                    spinner.classList.add('not-visible');
                    var resolution = '302px';
                    if (innerWidth <= 600) {
                        resolution = 'none'
                    }
                    data.map(post => {
                        var date = new Date(`${post.created_at}`)
                        content_container.innerHTML += `<li><a href="/post/${post.slug}/">
                        <div class="main-blog-img">

                            <img style="max-height: ${resolution}" src="/media/${post.photo}" alt="img">

                        </div>
                        <div class="main-blog-content">
                            <h2>${post.title}</h2>
                            <p >${post.content.substr(0, 100)} â€¦
                            </p>
                            <span class="date">${date.toLocaleString("en-US", dateOptions)}</span>
                        </div>
                    </a></li>`
                    });
                },
                complete: function () {
                    if (_current_item >= total) {
                        noMore.classList.remove('not-visible');
                        ajaxNavBlock.style.background = '#fff';
                    } else {
                        loadBtn.classList.remove('not-visible');
                    }
                },
                error: function (err) {
                    console.log(err);
                }
            })
        }

        loadBtn.addEventListener('click', () => {
            loadmorePost()
        })
    </script>

    </section>
</div>
</div>

{% endblock %}